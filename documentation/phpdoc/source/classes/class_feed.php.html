<html>
    <head>
        <script
            type="text/javascript"
            src="../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Provides a resource for building an rss or
 * atom feed.
 */

/**
 * Include the inherited dataMonger class
 */
include_once GNAT_ROOT.'/classes/class_dataMonger.php';
include_once GNAT_ROOT.'/classes/class_article.php';
include_once GNAT_ROOT.'/classes/class_mappedArticle.php';
include_once GNAT_ROOT.'/classes/class_stdClassArticle.php';
include_once GNAT_ROOT.'/classes/class_lock.php';
include_once GNAT_ROOT.'/classes/class_directoryIndex.php';

/**
 * Defines a data object to contain an atom feed as items
 * are added and the feed is updated then returned
 */
class feed extends directoryIndex{

	private $articles;
	
	/**
	 * Creates an empty atom feed object with metadata
	 * 
	 * @param $title (str): a title for the atom feed
	 * @param $link (str): the base url for the feed
	 * @param $description (str): a description or summary of the feed
	 * @param $feedstamp (str): a datestamp for the feed, in standard atom format
	 */
	public function __construct( $directory, $bloguri ) {

		parent::__construct( $directory, $bloguri, &quot;feed&quot; );

		$this-&gt;loadArticles();

	}

	public function update(){

		parent::update( &quot;dump&quot; );
	}

	private function loadArticles(){

		foreach ($this-&gt;indexData as $item) {
			
			$this-&gt;articles[] = new mappedArticle( $item );

		}

	}



	public function reset($title, $link, $description, $feedstamp){

		$metadata = array();
		$metadata['title'] = $title;
		$metadata['link'] = $link;
		$metadata['description'] = $description;
		$metadata['feedstamp'] = $feedstamp;
		$metadata['author'] = getConfigOption('site_author');

		parent::regen( &quot;dump&quot;, $metadata );



	}
	
	/**
	 * Returns a valid feed with the requested format.
	 * 
	 * @param $type - the type of feed to return (atom/rss). Defaults
	 * to atom (superior) if the type given not recognized.
	 */
	public function output( $type ){
		
		if ( $type == &quot;rss&quot; ){
			return $this-&gt;rss();
		}
		
		else{
			
			return $this-&gt;atom();
		}
	}
	/**
	 * Returns a displayable representation of the feed
	 * with appropriate code added.  Relies on the article 
	 * atom_output() function to generate code for individidual
	 * feed items. Returns ATOM format.
	 * 
	 */
	private function atom() {

		$r = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;';
		$r .='&lt;feed xmlns=&quot;http://www.w3.org/2005/Atom&quot;
xml:lang=&quot;en&quot;
xml:base=&quot;'.getConfigOption('site_domain').'/&quot;&gt;';
		$r .= &quot;\n&quot;;
		$r .= '&lt;subtitle type=&quot;html&quot;&gt;' . $this-&gt;metadata['description'] . &quot;&lt;/subtitle&gt;\n&quot;;
		$r .= &quot;&quot;;
		$r .= &quot;&lt;id&gt;&quot; . $this-&gt;metadata['link'] . &quot;&lt;/id&gt;\n&quot;;
		$r .= &quot;&lt;title&gt;&quot; . $this-&gt;metadata['title'] . &quot;&lt;/title&gt;\n&quot;;
		$r .= &quot;&lt;updated&gt;&quot;. $this-&gt;metadata['feedstamp'] .&quot;&lt;/updated&gt;\n&quot;;
		$r .= &quot;&lt;author&gt;&lt;name&gt;&quot;.$this-&gt;metadata['author'].&quot;&lt;/name&gt;&lt;/author&gt;\n&quot;;
		$r .= '&lt;atom10:link xmlns:atom10=&quot;http://www.w3.org/2005/Atom&quot; rel=&quot;self&quot; type=&quot;application/atom+xml&quot; href=&quot;'.$this-&gt;metadata['link'].'/feed.php&quot; /&gt;';
		foreach ($this-&gt;articles as $item) {
			$r .= $item-&gt;output( 'atom' );
		}
		$r .= &quot;&lt;/feed&gt;&quot;;
		return $r;
	}
	
	/**
	 * Returns a displayable representation of the feed with 
	 * appropriate code added for RSS format.
	 */
	private function rss() {
		
		# The code produced is not valid due to the xml tag 
		# which should have a ? before each &lt;&gt;. This breaks the
		# php.
		
		$r ='&lt;xml version=&quot;1.0&quot;&gt;';
		$r .= '&lt;rss version = &quot;2.0&quot;&gt;\n';
		$r .= &quot;&lt;channel&gt;&quot;;
		$r .= &quot;&lt;title&gt;&quot; . $this-&gt;metadata['title'] . &quot;&lt;/title&gt;&quot;;
		$r .= &quot;&lt;link&gt;&quot; . $this-&gt;metadata['link'] . &quot;&lt;/link&gt;&quot;;
		$r .= &quot;&lt;description&gt;&quot; . $this-&gt;metadata['description'] . &quot;&lt;/description&gt;&quot;;
		foreach ($this-&gt;articles as $item){
			$r .= $item-&gt;output( 'rss' );
		}
		
		$r .= &quot;&lt;/channel&gt;&quot;;
		$r .= &quot;&lt;/rss&gt;&quot;;		
		
		return $r;
	}

}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>